name: fedora_copr-build

on:
  # Uncomment to be able to trigger the workflow manually
  # See https://docs.github.com/en/actions/reference/events-that-trigger-workflows#manual-events
  workflow_dispatch: {}

  schedule:
    # Everyday at 00:45am
    # See https://docs.github.com/en/actions/reference/events-that-trigger-workflows#schedule
    - cron: '45 0 * * *'

jobs:

  fedora_copr-build:
    name: Fedora Copr Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: "checkout this repo"
        uses: actions/checkout@v3

      - name: "Check for cached dependencies"
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: "install python requirements"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "prepare variables"
        # We specify the secrets here and give them an alias for other steps to
        # repeat the options.
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: vars
        run: |
          project_today="@fedora-llvm-team/llvm-snapshots-incubator-`date +%Y%m%d`"
          project_yesterday="@fedora-llvm-team/llvm-snapshots-incubator-`date -d '-1 day' +%Y%m%d`"
          project_target="@fedora-llvm-team/llvm-snapshots"

          echo "project_today=$project_today" >> $GITHUB_ENV
          echo "project_yesterday=$project_yesterday" >> $GITHUB_ENV
          echo "project_target=$project_target" >> $GITHUB_ENV

          # check if yesterday's project exists
          yesterdays_project_exists=`python -m llvm_snapshot_builder.cli project-exists --proj "$project_yesterday" && echo "yes" || echo "no"`
          echo "yesterdays_project_exists=$yesterdays_project_exists" >> $GITHUB_ENV

          # check if target project exists
          target_project_exists=`python -m llvm_snapshot_builder.cli project-exists --proj "$project_target" && echo "yes" || echo "no"`
          echo "target_project_exists=$target_project_exists" >> $GITHUB_ENV

      - name: "create today's project ${{ env.project_today }}"
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llvm_snapshot_builder.cli --verbose \
            create-project \
              --proj "${{ env.project_today }}" \
              --description-file "project-description.md" \
              --instructions-file "project-instructions.md" \
              --delete-after-days 32 \
              --chroots \
                fedora-36-aarch64 \
                fedora-36-ppc64le \
                fedora-36-x86_64 \
                fedora-36-i386 \
                fedora-36-s390x \
                fedora-37-aarch64 \
                fedora-37-ppc64le \
                fedora-37-x86_64 \
                fedora-37-i386 \
                fedora-37-s390x \
                fedora-rawhide-aarch64 \
                fedora-rawhide-ppc64le \
                fedora-rawhide-x86_64 \
                fedora-rawhide-i386 \
                fedora-rawhide-s390x \
              --update

      - name: "create packages in today's project ${{ env.project_today }}"
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llvm_snapshot_builder.cli --verbose \
            create-packages \
              --proj "${{ env.project_today }}" \
              --packagenames python-lit llvm clang lld \
              --update

      - name: "copr kick-off new builds in ${{ env.project_today }}"
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llvm_snapshot_builder.cli --verbose \
            build-packages \
            --proj "${{ env.project_today }}" \
            --packagenames python-lit llvm clang lld \
            --chroots \
                fedora-36-aarch64 \
                fedora-36-ppc64le \
                fedora-36-x86_64 \
                fedora-36-i386 \
                fedora-36-s390x \
                fedora-37-aarch64 \
                fedora-37-ppc64le \
                fedora-37-x86_64 \
                fedora-37-i386 \
                fedora-37-s390x \
                fedora-rawhide-aarch64 \
                fedora-rawhide-ppc64le \
                fedora-rawhide-x86_64 \
                fedora-rawhide-i386 \
                fedora-rawhide-s390x \
            --timeout "108000" 

      - name: delete project at ${{ env.project_target }} before forking to it
        if: ${{ env.yesterdays_project_exists == 'yes' && env.target_project_exists == 'yes' }}
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llvm_snapshot_builder.cli --verbose \
          delete-project \
            --proj "${{ env.project_target }}"

      - name: copr fork project from ${{ env.project_yesterday }} to ${{ env.project_target }}
        if: ${{ env.yesterdays_project_exists == 'yes' }}
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llvm_snapshot_builder.cli --verbose \
          fork-project \
            --source "${{ env.project_yesterday }}" \
            --target "${{ env.project_target }}"


      - name: copr regenerate ${{ env.project_target }}
        # If yesterday's project didn't exist, we haven't forked and so we don't
        # need to regenerate the repos.
        if: ${{ env.yesterdays_project_exists == 'yes' }}
        env:
          # You need to have those secrets in your repo.
          # See also: https://copr.fedorainfracloud.org/api/.
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_URL: ${{ secrets.COPR_URL }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
          COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llvm_snapshot_builder.cli --verbose \
            regenerate-repos --proj "${{ env.project_target }}"
            
