#
# Snapshot gating tests for all *LLVM* packages in the mix
#
# Compatible with these distributions:
#
#   * Fedora
#

# Docs for this file format: https://tmt.readthedocs.io/en/stable/

summary: LLVM Tests for snapshot gating
prepare:
  - name: Enable copr repo
    how: shell
    script:
      - dnf install -y 'dnf5-command(copr)' || dnf install -y 'dnf-command(copr)'
      - dnf install -y 'dnf5-command(config-manager)' || dnf install -y 'dnf-command(config-manager)'
      - dnf -y copr enable @fedora-llvm-team/$COPR_PROJECT $COPR_CHROOT
      # Use a newer llvm-test-suite version from copr.
      - dnf copr enable -y @fedora-llvm-team/llvm-test-suite $COPR_CHROOT
      # Increase the priority of the copr repositories in order to prefer packages from them.
      # Testing Farm uses priority=9 by default.
      # Source: https://docs.testing-farm.io/Testing%20Farm/0.1/test-environment.html#_tag_repository
      - dnf config-manager --save --setopt="copr:copr.fedorainfracloud.org:group_fedora-llvm-team:*.priority=8" || dnf config-manager setopt "copr:copr.fedorainfracloud.org:group_fedora-llvm-team:*.priority=8"
      # Ensure that latest llvm-libs (from our snapshot) is installed to prevent
      # potential dependency solving issues when rpms depending on llvm-libs are
      # already in the system.
      - dnf -y install --best llvm-libs

  - name: "Check that snapshot version of LLVM is installed"
    how: shell
    order: 99
    script: rpm -q --qf "%{nvr}" llvm-libs | grep -P '~pre|pre\.'
adjust:
  - discover+:
      - name: redhat-rpm-config-tests
        how: fmf
        url: https://src.fedoraproject.org/rpms/redhat-rpm-config.git
        ref: main
        filter: "tag:-spoils-installation & tag:-not-in-default"
        test: brp-llvm-compile-lto-elf
    when: distro > fedora-37

  # TODO: this will be removed when flang is integrated into regular Fedora llvm
  # and tests/flang integrated into tests/llvm as well.
  - discover+:
      - name: flang-tests
        how: fmf
        url: https://src.fedoraproject.org/tests/flang.git
        ref: main
    when: >
      build-strategy == with-flang
        and distro ~>= fedora-44
        and arch == x86_64, ppc64le, aarch64
        and snapshot is defined

  # TODO Remove after MLIR builds are enabled
  # MLIR builds on fedora < 44 were disabled recently due to nanobind
  # dependency version
  - discover+:
      adjust-tests:
      - require-~:
        - '^mlir'
    when: distro <= fedora-43

discover:
    - name: llvm-tests
      how: fmf
      url: https://src.fedoraproject.org/tests/llvm.git
      ref: main
      filter: "tag:-spoils-installation & tag:-not-in-default"

      # TODO(kwk): In case we want to import a test and ignore its result for
      # experimentation reasons using
      # https://tmt.readthedocs.io/en/stable/spec/tests.html#result, we should
      # see https://github.com/teemtee/tmt/discussions/2430 and
      # https://github.com/teemtee/tmt/issues/1843
execute:
    how: tmt
